<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برنامج الحسابات – إصدار متكامل</title>

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root{
            --primary:#0a3d62;
            --secondary:#3c6382;
            --accent:#60a3bc;
            --success:#78e08f;
            --warning:#f6b93b;
            --danger:#e55039;
            --bg:#f1f2f6;
            --card:#ffffff;
            --text:#2f3542;
            --border:#ddd;
            --shadow:0 4px 6px rgba(0,0,0,.1);
            --shadow-hover:0 8px 15px rgba(0,0,0,.2);
        }

        body{
            font-family:'Tajawal',sans-serif;
            background:var(--bg);
            color:var(--text);
            margin:0;
            padding:0;
            overflow-x:hidden;
        }

        /* Sidebar – Responsive */
        .sidebar{
            position:fixed;
            top:0;right:0;
            width:250px;height:100vh;
            background:linear-gradient(180deg,var(--primary),var(--secondary));
            padding-top:20px;
            transition:transform .3s ease;
            z-index:1050;
        }
        .sidebar .nav-link{
            color:rgba(255,255,255,.85);
            padding:12px 25px;
            display:flex;align-items:center;
            transition:.3s;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active{
            background-color:var(--accent);
            color:#fff;
        }
        .sidebar .nav-link i{
            margin-left:10px;
        }
        .main-content{
            margin-right:250px;
            padding:25px;
            transition:margin .3s ease;
        }
        .mobile-toggle{
            display:none;
            position:fixed;
            top:15px;right:15px;
            z-index:1100;
            background:var(--primary);
            color:#fff;
            border:0;
            border-radius:5px;
            padding:8px 12px;
            font-size:1.4rem;
        }

        /* Responsive */
        @media(max-width:768px){
            .sidebar{transform:translateX(100%);width:100%;}
            .sidebar.show{transform:translateX(0);}
            .main-content{margin-right:0;}
            .mobile-toggle{display:block;}
        }

        /* Cards & Tables */
        .card{
            border:none;border-radius:12px;
            box-shadow:var(--shadow);
            transition:var(--shadow-hover) .3s;
            overflow:hidden;
        }
        .card:hover{box-shadow:var(--shadow-hover);}
        .card-header{
            background:var(--primary);color:#fff;
        }
        .table th{
            background:var(--accent);color:#fff;
            vertical-align:middle;
        }
        .table td{vertical-align:middle;}

        /* Buttons */
        .btn-primary{background:var(--accent);border:0;}
        .btn-success{background:var(--success);border:0;}
        .btn-danger{background:var(--danger);border:0;}
        .btn-warning{background:var(--warning);border:0;}

        /* Pages */
        .page{display:none;animation:fade .4s;}
        .page.active{display:block;}
        @keyframes fade{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:none;}}

        /* Utilities */
        .summary-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;}
        .summary-box{background:var(--card);padding:20px;border-radius:10px;text-align:center;border-top:4px solid var(--accent);}
        .summary-title{font-size:.9rem;color:var(--text);opacity:.7;}
        .summary-value{font-size:1.5rem;font-weight:700;color:var(--primary);}
    </style>
</head>
<body>

<button class="mobile-toggle"><i class="bi bi-list"></i></button>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-2 sidebar" id="sidebar">
            <h4 class="text-center text-white mb-4" id="project-name-sidebar">برنامج الحسابات</h4>
            <ul class="nav flex-column">
                <li class="nav-item"><a href="#" data-page="dashboard" class="nav-link active"><i class="bi bi-speedometer2"></i> لوحة التحكم</a></li>
                <li class="nav-item"><a href="#" data-page="products" class="nav-link"><i class="bi bi-box-seam"></i> المنتجات</a></li>
                <li class="nav-item"><a href="#" data-page="invoices" class="nav-link"><i class="bi bi-receipt"></i> الفواتير</a></li>
                <li class="nav-item"><a href="#" data-page="settings" class="nav-link"><i class="bi bi-gear"></i> الإعدادات</a></li>
            </ul>
        </div>

        <!-- Content -->
        <div class="main-content">
            <!-- Dashboard -->
            <div id="dashboard" class="page active">
                <h2 class="mb-4">لوحة التحكم</h2>
                <div class="summary-container">
                    <div class="summary-box"><div class="summary-title">الفواتير</div><div class="summary-value" id="dash-invoices">0</div></div>
                    <div class="summary-box"><div class="summary-title">المنتجات</div><div class="summary-value" id="dash-products">0</div></div>
                    <div class="summary-box"><div class="summary-title">الإيرادات</div><div class="summary-value" id="dash-revenue">0.000 د.ب</div></div>
                </div>
                <div class="card">
                    <div class="card-header">آخر الفواتير</div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr><th>رقم</th><th>العميل</th><th>التاريخ</th><th>المبلغ</th></tr>
                                </thead>
                                <tbody id="recent-invoices">
                                    <tr><td colspan="4" class="text-center">لا توجد فواتير حديثة</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- المنتجات (تكلفة + قائمة) -->
            <div id="products" class="page">
                <h2 class="mb-4">المنتجات</h2>
                <div class="card mb-4">
                    <div class="card-header">حساب تكلفة المنتج</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3"><label>اسم المنتج</label><input class="form-control" id="prod-name" placeholder="اسم المنتج"></div>
                            <div class="col-md-3"><label>رمز المنتج</label><input class="form-control" id="prod-code" readonly></div>
                            <div class="col-md-3"><label>القطع في العلبة</label><input class="form-control" type="number" id="prod-qty" value="1"></div>
                            <div class="col-md-3"><label>نسبة الربح (%)</label><input class="form-control" type="number" id="prod-profit" value="25"></div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6>تكلفة المواد</h6>
                                <table class="table table-sm" id="material-table">
                                    <thead><tr><th>مادة</th><th>عدد</th><th>سعر</th><th>مستخدم</th><th>التكلفة</th><th></th></tr></thead>
                                    <tbody>
                                        <tr><td><input class="form-control form-control-sm"></td><td><input type="number" class="form-control form-control-sm"></td><td><input type="number" class="form-control form-control-sm" step="0.001"></td><td><input type="number" class="form-control form-control-sm"></td><td class="mat-cost">0.000</td><td><button class="btn btn-sm btn-danger remove-mat"><i class="bi bi-trash"></i></button></td></tr>
                                    </tbody>
                                </table>
                                <button class="btn btn-sm btn-outline-primary" id="add-mat">+ مادة</button>
                            </div>
                            <div class="col-md-6">
                                <h6>العمالة</h6>
                                <table class="table table-sm" id="labor-table">
                                    <thead><tr><th>عامل</th><th>راتب/ شهري</th><th>ساعات</th><th>قطع</th><th>تكلفة القطعة</th><th></th></tr></thead>
                                    <tbody>
                                        <tr><td><input class="form-control form-control-sm"></td><td><input type="number" class="form-control form-control-sm" step="0.001"></td><td><input type="number" class="form-control form-control-sm"></td><td><input type="number" class="form-control form-control-sm"></td><td class="labor-cost">0.000</td><td><button class="btn btn-sm btn-danger remove-labor"><i class="bi bi-trash"></i></button></td></tr>
                                    </tbody>
                                </table>
                                <button class="btn btn-sm btn-outline-primary" id="add-labor">+ عامل</button>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6>التغليف وإهلاك المعدات</h6>
                                <div class="row">
                                    <div class="col-6"><label>تكلفة التغليف</label><input type="number" class="form-control" id="pack-cost" step="0.001" value="0"></div>
                                    <div class="col-6"><label>نسبة إهلاك (%)</label><input type="number" class="form-control" id="dep-rate" value="5"></div>
                                </div>
                            </div>
                            <div class="col-md-6 d-flex flex-column justify-content-center">
                                <div class="alert alert-info">
                                    <strong>السعر المقترح: </strong><span id="suggested-price">0.000</span> د.ب
                                </div>
                                <button class="btn btn-primary" id="save-prod">حفظ المنتج</button>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">قائمة المنتجات</div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="products-table">
                                    <thead>
                                        <tr><th>رمز</th><th>اسم المنتج</th><th>القطع</th><th>التكلفة</th><th>البيع</th><th>الربح %</th><th></th></tr>
                                    </thead>
                                    <tbody>
                                        <tr><td colspan="7" class="text-center">لا توجد منتجات</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- الفواتير (اصلاح التنقل) -->
                <div id="invoices" class="page">
                    <h2 class="mb-4">الفواتير</h2>
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <button class="btn btn-outline-primary active" id="btn-new">فاتورة جديدة</button>
                        <button class="btn btn-outline-secondary" id="btn-list">قائمة الفواتير</button>
                        <button class="btn btn-outline-info" id="btn-track">تتبع الفواتير</button>
                    </div>

                    <!-- فاتورة جديدة -->
                    <div id="invoice-new" class="invoice-section">
                        <div class="card">
                            <div class="card-header">إنشاء فاتورة جديدة</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3"><label>رقم الفاتورة</label><input class="form-control" id="inv-num" readonly></div>
                    <div class="col-md-3"><label>العميل</label><input class="form-control" id="inv-client" placeholder="اسم العميل"></div>
                    <div class="col-md-3"><label>الهاتف</label><input class="form-control" id="inv-phone" placeholder="رقم الهاتف"></div>
                    <div class="col-md-3"><label>التاريخ</label><input type="date" class="form-control" id="inv-date"></div>
                </div>
                <h6 class="mt-3">عناصر الفاتورة</h6>
                <div class="table-responsive">
                    <table class="table table-sm" id="inv-items">
                        <thead>
                            <tr>
                                <th style="width:35%">المنتج</th>
                                <th style="width:15%">سعر الوحدة</th>
                                <th style="width:10%">الكمية</th>
                                <th style="width:15%">السعر</th>
                                <th style="width:10%" class="tax-th">الضريبة</th>
                                <th style="width:10%">الإجمالي</th>
                                <th style="width:5%"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><select class="form-select inv-product"></select></td>
                                <td><input type="number" class="form-control unit-price" step="0.001"></td>
                                <td><input type="number" class="form-control qty" value="1" min="1"></td>
                                <td class="price">0.000</td>
                                <td class="tax-amount tax-th">0.000</td>
                                <td class="total">0.000</td>
                                <td><button class="btn btn-sm btn-danger remove-item"><i class="bi bi-trash"></i></button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <button class="btn btn-sm btn-outline-primary" id="add-item">+ عنصر</button>
                <div class="row mt-3">
                    <div class="col-md-6"></div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-1"><span>المجموع:</span> <span id="inv-subtotal">0.000 د.ب</span></div>
                                <div class="d-flex justify-content-between mb-1 tax-row"><span>الضريبة:</span> <span id="inv-tax">0.000 د.ب</span></div>
                                <div class="d-flex justify-content-between mb-1"><span>التوصيل:</span> <span id="inv-delivery">0.000 د.ب</span></div>
                                <div class="d-flex justify-content-between fw-bold text-success"><span>الإجمالي:</span> <span id="inv-total">0.000 د.ب</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-end mt-3">
                    <button class="btn btn-primary me-2" id="preview-invoice"><i class="bi bi-eye"></i> معاينة</button>
                    <button class="btn btn-success" id="save-invoice-btn"><i class="bi bi-check-circle"></i> حفظ</button>
                </div>
            </div>
        </div>
                    </div>

                    <!-- قائمة الفواتير -->
                    <div id="invoice-list" class="invoice-section" style="display:none;">
                        <div class="card">
                            <div class="card-header">قائمة الفواتير</div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr><th>رقم الفاتورة</th><th>العميل</th><th>التاريخ</th><th>المجموع</th><th>الإجراءات</th></tr>
                                        </thead>
                                        <tbody id="invoices-tbody">
                                            <tr><td colspan="5" class="text-center">لا توجد فواتير</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- تتبع الفواتير -->
                    <div id="invoice-track" class="invoice-section" style="display:none;">
                        <div class="card">
                            <div class="card-header">تتبع الفواتير</div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr><th>رقم الفاتورة</th><th>العميل</th><th>التاريخ</th><th>الحالة</th><th>الإجمالي</th></tr>
                                        </thead>
                                        <tbody id="track-tbody">
                                            <tr><td colspan="5" class="text-center">لا توجد فواتير</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- الإعدادات -->
                <div id="settings" class="page">
                    <h2 class="mb-4">الإعدادات</h2>
                    <!-- المشروع -->
                    <div class="card mb-4">
                        <div class="card-header">تفاصيل المشروع</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">اسم المشروع</label>
                                    <input type="text" class="form-control" id="setting-project-name">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">الهاتف</label>
                                    <div class="input-group">
                                        <select class="form-select" id="setting-country-code" style="max-width:120px;">
                                            <option value="+973">+973 (البحرين)</option>
                                            <option value="+966">+966 (السعودية)</option>
                                            <option value="+971">+971 (الإمارات)</option>
                                            <option value="+974">+974 (قطر)</option>
                                            <option value="+965">+965 (الكويت)</option>
                                            <option value="+968">+968 (عمان)</option>
                                        </select>
                                        <input type="tel" class="form-control" id="setting-phone-number">
                                    </div>
                                </div>
                            </div>
                            <label class="form-label mt-2">العنوان</label>
                            <textarea class="form-control" id="setting-address" rows="2"></textarea>
                        </div>
                    </div>

                    <!-- الضريبة -->
                    <div class="card">
                        <div class="card-header">الضريبة</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-check-label">تفعيل الضريبة</label>
                                    <input type="checkbox" class="form-check-input" id="setting-tax-enabled">
                                </div>
                                <div class="col-md-6">
                                    <label>نسبة الضريبة (%)</label>
                                    <input type="number" class="form-control" id="setting-tax-rate" min="0" max="100" value="5">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="invoicePreviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">معاينة الفاتورة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title text-center">فاتورة مبيعات</h5>
                            <div class="row mb-3">
                                <div class="col-md-6"><strong>العميل:</strong> <span id="prev-client"></span></div>
                                <div class="col-md-6"><strong>التاريخ:</strong> <span id="prev-date"></span></div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th style="width:35%">المنتج</th>
                                            <th style="width:15%">سعر الوحدة</th>
                                            <th style="width:10%">الكمية</th>
                                            <th style="width:15%">السعر</th>
                                            <th style="width:10%" class="tax-th">الضريبة</th>
                                            <th style="width:10%">الإجمالي</th>
                                        </tr>
                                    </thead>
                                    <tbody id="prev-items"></tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>المجموع:</span><span id="prev-subtotal">0.000 د.ب</span>
                            </div>
                            <div class="d-flex justify-content-between tax-row">
                                <span>الضريبة:</span><span id="prev-tax">0.000 د.ب</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>التوصيل:</span><span id="prev-delivery">0.000 د.ب</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between fw-bold text-success">
                                <span>الإجمالي النهائي:</span><span id="prev-total">0.000 د.ب</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                    <button type="button" class="btn btn-primary" id="print-invoice"><i class="bi bi-printer"></i> طباعة</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Responsive Sidebar
        const mobileToggle = document.querySelector('.mobile-toggle');
        const sidebar = document.getElementById('sidebar');
        mobileToggle.addEventListener('click', () => sidebar.classList.toggle('show'));
        document.addEventListener('click', e => {
            if (window.innerWidth <= 768 && !sidebar.contains(e.target) && e.target !== mobileToggle) sidebar.classList.remove('show');
        });

        // Navigation
        document.querySelectorAll('[data-page]').forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                const pageId = e.target.getAttribute('data-page');
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
                e.target.classList.add('active');
                if (window.innerWidth <= 768) sidebar.classList.remove('show');
            });
        });

        // Tabs inside invoices
        const invoiceBtns = ['btn-new','btn-list','btn-track'];
        const invoiceSections = ['invoice-new','invoice-list','invoice-track'];
        invoiceBtns.forEach(btn=>{
            document.getElementById(btn).addEventListener('click',()=>{
                invoiceBtns.forEach(b=>document.getElementById(b).classList.remove('active','btn-primary'));
                invoiceSections.forEach(s=>document.getElementById(s).style.display='none');
                document.getElementById(btn).classList.add('active','btn-primary');
                document.getElementById(btn.replace('btn-','invoice-')).style.display='block';
            });
        });

        // Settings
        const taxEnabled = document.getElementById('setting-tax-enabled');
        const taxRate = document.getElementById('setting-tax-rate');
        function showTax(){
            document.querySelectorAll('.tax-th,.tax-row').forEach(el=>el.style.display=taxEnabled.checked?'':'none');
        }
        taxEnabled.addEventListener('change',showTax);
        showTax();

        // Product Cost
        let products = JSON.parse(localStorage.getItem('products') || '[]');
        let lastCode = products.length;
        function generateCode(){return 'PRD-' + (++lastCode).toString().padStart(4,0);}
        document.getElementById('prod-code').value = generateCode();

        document.getElementById('add-mat').addEventListener('click',()=>{
            const tbody=document.getElementById('material-table').tBodies[0];
            tbody.insertAdjacentHTML('beforeend',`<tr><td><input class="form-control form-control-sm"></td><td><input type="number" class="form-control form-control-sm"></td><td><input type="number" class="form-control form-control-sm" step="0.001"></td><td><input type="number" class="form-control form-control-sm"></td><td class="mat-cost">0.000</td><td><button class="btn btn-sm btn-danger remove-mat"><i class="bi bi-trash"></i></button></td></tr>`);
            tbody.querySelector('tr:last-child .remove-mat').addEventListener('click',e=>e.target.closest('tr').remove());
        });
        document.getElementById('add-labor').addEventListener('click',()=>{
            const tbody=document.getElementById('labor-table').tBodies[0];
            tbody.insertAdjacentHTML('beforeend',`<tr><td><input class="form-control form-control-sm"></td><td><input type="number" class="form-control form-control-sm" step="0.001"></td><td><input type="number" class="form-control form-control-sm"></td><td><input type="number" class="form-control form-control-sm"></td><td class="labor-cost">0.000</td><td><button class="btn btn-sm btn-danger remove-labor"><i class="bi bi-trash"></i></button></td></tr>`);
            tbody.querySelector('tr:last-child .remove-labor').addEventListener('click',e=>e.target.closest('tr').remove());
        });

        // Invoice
        let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
        document.getElementById('inv-num').value = 'INV-' + new Date().getFullYear() + '-' + (invoices.length+1).toString().padStart(4,0);
        document.getElementById('inv-date').valueAsDate = new Date();

        // Load products to selects
        function loadProductsToSelects(){
            const selects = document.querySelectorAll('.inv-product');
            selects.forEach(sel=>{
                sel.innerHTML='<option value="">اختر منتج</option>';
                products.forEach(p=>sel.insertAdjacentHTML('beforeend',`<option value="${p.code}" data-price="${p.finalPrice}">${p.name}</option>`));
            });
        }
        loadProductsToSelects();

        // Initialize
        loadProductsToSelects();
        document.getElementById('prod-name').focus();
    </script>
</body>
</html>
