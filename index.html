            // التحقق مما إذا كان المنتج موجودًا بالفعل للتحديث
            const existingIndex = products.findIndex(p => p.code === productData.code);
            if (existingIndex >= 0) {
                products[existingIndex] = productData;
            } else {
                products.push(productData);
            }
            
            // حفظ في localStorage
            localStorage.setItem('products', JSON.stringify(products));
            
            // تحديث الجدول
            refreshProductsTable();
            
            // إعادة تعيين النموذج
            resetForm();
            
            // الانتقال إلى صفحة المنتجات
            document.querySelector('[data-page="products"]').click();
        });

        // الحصول على بيانات الجدول
        function getTableData(tableId) {
            const rows = [];
            document.querySelectorAll(`#${tableId} tbody tr`).forEach(row => {
                const inputs = row.querySelectorAll('input');
                const rowData = {
                    product: inputs[0].value,
                    count: inputs[1].value,
                    price: inputs[2].value,
                    used: inputs[3].value,
                    cost: row.querySelector('td:nth-last-child(2)').textContent
                };
                rows.push(rowData);
            });
            return rows;
        }

        // تحديث جدول المنتجات
        function refreshProductsTable() {
            const tbody = document.querySelector('#products-list');
            tbody.innerHTML = '';

            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center">لا توجد منتجات مسجلة بعد</td></tr>';
                return;
            }

            products.forEach(product => {
                const piecesPerPackage = parseFloat(product.piecesPerPackage) || 1;
                const laborCostPerPiece = parseFloat(product.laborCost) || 0;
                const laborCostPerPackage = (laborCostPerPiece * piecesPerPackage).toFixed(3);
                const packageCost = parseFloat(product.packageCost) || 0;
                const finalPrice = parseFloat(product.finalPrice) || 0;
                const profitMargin = (finalPrice - packageCost).toFixed(3);
                const profitRate = packageCost > 0 ? ((finalPrice - packageCost) / packageCost * 100).toFixed(1) : '0.0';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.code}</td>
                    <td>${product.name}</td>
                    <td>${piecesPerPackage}</td>
                    <td>${packageCost.toFixed(3)} ${currencySymbols[currentCurrency]}</td>
                    <td>${finalPrice.toFixed(3)} ${currencySymbols[currentCurrency]}</td>
                    <td>${profitRate}%</td>
                    <td>${profitMargin} ${currencySymbols[currentCurrency]}</td>
                    <td>${laborCostPerPackage} ${currencySymbols[currentCurrency]}</td>
                    <td>${product.depreciationCost || '0.000'} ${currencySymbols[currentCurrency]}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-info view-product" data-code="${product.code}">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-warning edit-product" data-code="${product.code}">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-product" data-code="${product.code}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);

                // إضافة مستمعي الأحداث للأزرار
                row.querySelector('.view-product').addEventListener('click', () => viewProduct(product.code));
                row.querySelector('.edit-product').addEventListener('click', () => editProduct(product.code));
                row.querySelector('.delete-product').addEventListener('click', () => deleteProduct(product.code));
            });
        }

        // عرض تفاصيل المنتج
        function viewProduct(productCode) {
            const product = products.find(p => p.code === productCode);
            if (!product) return;

            // تعبئة البيانات في النافذة المنبثقة
            document.getElementById('detail-name').textContent = product.name;
            document.getElementById('detail-code').textContent = product.code;
            document.getElementById('detail-pieces').textContent = product.piecesPerPackage;
            document.getElementById('detail-package-cost').textContent = product.packageCost.toFixed(3) + ' ' + currencySymbols[currentCurrency];
            document.getElementById('detail-final-price').textContent = product.finalPrice + ' ' + currencySymbols[currentCurrency];
            document.getElementById('detail-profit-rate').textContent = product.profitRate + '%';
            document.getElementById('detail-profit-margin').textContent = (product.finalPrice - product.packageCost).toFixed(3) + ' ' + currencySymbols[currentCurrency];
            
            const laborCostPerPiece = parseFloat(product.laborCost) || 0;
            const laborCostPerPackage = (laborCostPerPiece * parseFloat(product.piecesPerPackage || 1)).toFixed(3);
            document.getElementById('detail-labor-cost').textContent = laborCostPerPackage + ' ' + currencySymbols[currentCurrency];
            
            document.getElementById('detail-depreciation').textContent = (product.depreciationCost || '0.000') + ' ' + currencySymbols[currentCurrency];
            document.getElementById('detail-materials-cost').textContent = (product.materialsCost || '0.000') + ' ' + currencySymbols[currentCurrency];

            // عرض النافذة المنبثقة
            productDetailsModal.show();
        }

        // تحرير المنتج
        function editProduct(productCode) {
            const product = products.find(p => p.code === productCode);
            if (!product) return;

            // الانتقال إلى صفحة تكلفة المنتج
            document.querySelector('[data-page="product-cost"]').click();

            // تعبئة البيانات الأساسية
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-code').value = product.code;
            document.getElementById('sale-quantity').value = product.piecesPerPackage;
            document.getElementById('profit-rate').value = product.profitRate;
            document.getElementById('depreciation-rate').value = product.depreciationRate;
            document.getElementById('final-price').value = product.finalPrice;

            // تعبئة جداول المواد والتغليف والعمالة
            populateTable('materials-table', product.materialsTable || []);
            populateTable('packaging-table', product.packagingTable || []);
            populateTable('workers-table', product.workersTable || []);

            // تحديث الحسابات
            updateCosts();
        }

        // تعبئة الجدول بالبيانات
        function populateTable(tableId, data) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            tbody.innerHTML = '';

            if (data.length === 0) {
                // إضافة صف فارغ إذا لم يكن هناك بيانات
                if (tableId === 'materials-table' || tableId === 'packaging-table') {
                    addTableRow(tableId, tableId === 'materials-table' ? 'material' : 'packaging');
                } else if (tableId === 'workers-table') {
                    addWorkerRow();
                }
                return;
            }

            data.forEach(rowData => {
                if (tableId === 'materials-table' || tableId === 'packaging-table') {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td><input type="text" class="form-control" value="${rowData.product || ''}" required></td>
                        <td><input type="number" class="form-control" value="${rowData.count || ''}" required></td>
                        <td><input type="number" class="form-control" step="0.001" value="${rowData.price || ''}" required></td>
                        <td><input type="number" class="form-control" value="${rowData.used || ''}" required></td>
                        <td class="${tableId === 'materials-table' ? 'material-cost' : 'packaging-cost'}">${rowData.cost || '0.000'}</td>
                        <td><button class="btn btn-sm btn-danger remove-row"><i class="bi bi-trash"></i></button></td>
                    `;
                    tbody.appendChild(newRow);
                    setupRowEventListeners(newRow, tableId === 'materials-table' ? 'material' : 'packaging');
                } else if (tableId === 'workers-table') {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td><input type="text" class="form-control" value="${rowData.product || ''}" required></td>
                        <td>
