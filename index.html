        // Load cities
        const cities = JSON.parse(localStorage.getItem('deliveryCities') || '[]');
        const citySelect = document.getElementById('delivery-city');
        citySelect.innerHTML = '<option value="">اختر المدينة/المنطقة</option>';
        cities.forEach(city => {
            const option = document.createElement('option');
            option.value = city.name;
            option.textContent = city.name;
            citySelect.appendChild(option);
        });

        // Load tax settings
        updateTaxVisibility();
    }

    function savePaymentMethods() {
        const methods = [];
        document.querySelectorAll('#payment-methods-list tr').forEach(tr => {
            const name = tr.querySelector('input[type="text"]')?.value;
            const enabled = tr.querySelector('input[type="checkbox"]')?.checked;
            if (name) methods.push({name, enabled});
        });
        localStorage.setItem('paymentMethods', JSON.stringify(methods));
    }

    function saveProduct(){
        const name=document.getElementById('product-name').value;
        const code=document.getElementById('product-code').value;
        const qty=document.getElementById('sale-quantity').value;
        const profitRate=document.getElementById('profit-rate').value;
        const finalPrice=document.getElementById('final-price').value;
        
        if(!name || !qty || !profitRate || !finalPrice){
            alert('يرجى تعبئة جميع الحقول المطلوبة');
            return;
        }

        const product = {
            code: code,
            name: name,
            quantity: qty,
            totalCost: document.getElementById('grand-total-cost').textContent,
            finalPrice: formatCurrency(parseFloat(finalPrice)),
            profitRate: profitRate + '%',
            profitMargin: formatCurrency(parseFloat(finalPrice) - parseFloat(document.getElementById('grand-total-cost').textContent.replace(/[^0-9.]/g, ''))),
            laborCost: document.getElementById('labor-summary').textContent,
            depreciation: document.getElementById('depreciation-summary').textContent
        };
        
        if(editingIndex >= 0) {
            products[editingIndex] = product;
            editingIndex = -1;
        } else {
            products.push(product);
        }
        
        // Save detailed data
        const materials = [];
        document.querySelectorAll('#materials-table tbody tr').forEach(tr => {
            const inputs = tr.querySelectorAll('input');
            if (inputs[0].value) {
                materials.push({
                    name: inputs[0].value,
                    count: inputs[1].value,
                    price: inputs[2].value,
                    used: inputs[3].value,
                    cost: tr.querySelector('.material-cost').textContent
                });
            }
        });
        const packaging = [];
        document.querySelectorAll('#packaging-table tbody tr').forEach(tr => {
            const inputs = tr.querySelectorAll('input');
            if (inputs[0].value) {
                packaging.push({
                    name: inputs[0].value,
                    count: inputs[1].value,
                    price: inputs[2].value,
                    used: inputs[3].value,
                    cost: tr.querySelector('.packaging-cost').textContent
                });
            }
        });
        const workers = {
            salary: document.querySelector('#workers-table-1 tbody tr .salary').value,
            hours: document.querySelector('#workers-table-1 tbody tr .hours').value,
            pieces: document.querySelector('#workers-table-2 tbody tr .pieces').value
        };
        const depreciation = {
            rate: document.getElementById('depreciation-rate').value
        };
        localStorage.setItem('productDetails_' + code, JSON.stringify({materials, packaging, workers, depreciation}));
        
        localStorage.setItem('products', JSON.stringify(products));
        updateProductsTable();
        updateInvoiceProducts();
        clearForm();
        alert('تم حفظ المنتج بنجاح!');
        showPage('manage-products');
    }

    // Invoice product selection and auto-price
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('product-select')) {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const price = selectedOption.dataset.price;
            const row = e.target.closest('tr');
            const priceInput = row.querySelector('.unit-price');
            if (price) {
                priceInput.value = parseFloat(price).toFixed(currencyDecimals);
            } else {
                priceInput.value = '';
            }
            calculateRowTotal(row);
        }
    });

    function calculateRowTotal(row) {
        const price = parseFloat(row.querySelector('.unit-price').value) || 0;
        const quantity = parseFloat(row.querySelector('.quantity').value) || 1;
        const total = price * quantity;
        row.querySelector('.item-total').textContent = total.toFixed(currencyDecimals);
        calculateInvoiceTotals();
    }

    function calculateInvoiceTotals() {
        let subtotal = 0;
        let tax = 0;
        const taxSettings = JSON.parse(localStorage.getItem('taxSettings') || '{}');
        const taxRate = parseFloat(taxSettings.taxRate) || 0;
        
        document.querySelectorAll('#invoice-items-table tbody tr').forEach(row => {
            const total = parseFloat(row.querySelector('.item-total').textContent) || 0;
            subtotal += total;
            if (taxSettings.taxEnabled) {
                const itemTax = total * (taxRate / 100);
                tax += itemTax;
                row.querySelector('.item-tax').textContent = itemTax.toFixed(currencyDecimals);
            }
        });
        document.getElementById('invoice-subtotal').textContent = subtotal.toFixed(currencyDecimals) + ' ' + currentCurrency;
        document.getElementById('invoice-tax').textContent = tax.toFixed(currencyDecimals) + ' ' + currentCurrency;
        const delivery = parseFloat(document.getElementById('invoice-delivery').textContent) || 0;
        document.getElementById('invoice-total').textContent = (subtotal + tax + delivery).toFixed(currencyDecimals) + ' ' + currentCurrency;
    }

    // Invoice buttons
    document.getElementById('add-invoice-item').addEventListener('click', () => {
        const tbody = document.querySelector('#invoice-items-table tbody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="product-name-col"><select class="form-select-modern product-select"><option value="">اختر منتج</option></select></td>
            <td><input type="number" class="form-control-modern unit-price" readonly></td>
            <td><input type="number" class="form-control-modern quantity" value="1" min="1"></td>
            <td class="item-tax tax-related">0.000</td>
            <td class="item-total">0.000</td>
            <td><button class="btn btn-danger-modern btn-action remove-item"><i class="bi bi-trash"></i></button></td>`;
        tbody.appendChild(tr);
        updateInvoiceProducts();
        tr.querySelector('.quantity').addEventListener('input', () => calculateRowTotal(tr));
        tr.querySelector('.remove-item').addEventListener('click', () => { tr.remove(); calculateInvoiceTotals(); });
    });

    document.getElementById('preview-invoice').addEventListener('click', () => {
        alert('معاينة الفاتورة: قيد التنفيذ');
    });

    document.getElementById('save-draft').addEventListener('click', () => {
        alert('تم حفظ المسودة');
    });

    document.getElementById('save-invoice').addEventListener('click', () => {
        alert('تم حفظ الفاتورة');
    });

    document.getElementById('add-material').addEventListener('click',()=>addTableRow('materials-table'));
    document.getElementById('add-packaging').addEventListener('click',()=>addTableRow('packaging-table'));
    document.getElementById('sidebarToggle').addEventListener('click',()=>document.getElementById('sidebar').classList.toggle('show'));
    document.getElementById('save-product').addEventListener('click',saveProduct);
    document.getElementById('final-price').addEventListener('input', updateCosts);

    ['depreciation-rate','profit-rate','sale-quantity'].forEach(id=>{
        document.getElementById(id).addEventListener('input',updateCosts);
        document.getElementById(id).addEventListener('change',updateCosts);
        document.getElementById(id).addEventListener('keyup',updateCosts);
    });

    // Initialize
    updateProductsTable();
    updateInvoiceProducts();
    updateTaxVisibility();
    loadSettingsData();
    
    // Load saved delivery data
    const savedAreas = localStorage.getItem('deliveryAreas');
    const savedCities = localStorage.getItem('deliveryCities');
    if (savedAreas) {
        deliveryAreas = JSON.parse(savedAreas);
        updateDeliveryAreasTable();
    }
    if (savedCities) {
        deliveryCities = JSON.parse(savedCities);
        updateDeliveryCitiesTable();
    }
    
    updateCosts();
</script>

</body>
</html>
